function draw(e){var t=function(t){var n=e.filter(function(e){return e.year>t}),s=n.map(function(e){return e.shows.length}).reduce(function(e,t){return e+t},0);return n.length+s*heightSong},n=d3.select(".graph").append("svg").attr("width",width).attr("height",height),s=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(e,t,n){var s='<p class="song-name">'+e.name;e.album&&(s+=' <span style="color:#ccc">from</span> '+e.album),s+="</p>",s+='<span style="color:#ccc">at</span> '+t.name,s+=' <span style="color:#ccc">in</span> '+t.city,s+=t.state?", "+t.state:", "+t.country;var r=moment(n);return s+=' <span style="color:#ccc">on</span> '+r.format("MMMM D, YYYY")});n.call(s);var r=n.selectAll(".per-year").data(e).enter().append("g").attr("transform",function(e){return"translate(0,"+(margin.top+t(e.year))+")"}),a=d3.line().x(function(e){return e.x}).y(function(e){return e.y});r.append("path").attr("d",a([{x:0,y:0},{x:500,y:0}])).classed("year-divisor",!0);var i=r.append("text").attr("x",0).attr("y",25);i.append("tspan").attr("x",0).attr("y",25).text(function(e){return e.year}).classed("year-text",!0),i.append("tspan").attr("x",0).attr("y",60).text(function(e){return e.numberOfShows}).classed("stats-text",!0),i.append("tspan").attr("x",0).attr("y",70).text(function(e){return e.numberOfShows>1?"shows":"show"}).style("fill","#ccc"),i.append("tspan").attr("x",0).attr("y",95).text(function(e){return e.numberOfCountries}).classed("stats-text",!0),i.append("tspan").attr("x",0).attr("y",105).text(function(e){return e.numberOfCountries>1?"countries":"country"}).style("fill","#ccc");var l=r.selectAll("g").data(function(e){return e.shows}).enter().append("g").attr("transform",function(e,t){return"translate(70,"+(t*heightSong+1)+")"});l.selectAll("rect").data(function(e){return e.songs}).enter().append("rect").style("fill","#eee").attr("x",function(e,t){return t*widthSong}).attr("width",widthSong).attr("y",function(e){return 0}).attr("height",heightSong).attr("class",function(e){if(e.albumId&&e.songId)return"from-album song-"+e.songId+" album-"+e.albumId}).on("mouseover",function(e){var t=d3.select(this.parentNode).datum();s.show(e,t.venue,t.date),e.albumId&&(0===viewModel.selected()||viewModel.selected()===e.albumId)?d3.select(this).attr("opacity",.5):d3.select(this).style("fill","#ccc")}).on("mouseout",function(e){s.hide(e),e.albumId&&(0===viewModel.selected()||viewModel.selected()===e.albumId)?d3.select(this).attr("opacity",1):d3.select(this).style("fill","#eee")})}function subscribe(){viewModel.selected.subscribe(function(e){if(e){var t=viewModel.albums().find(function(t){return t.id===e});if(!t)return;t.songs.forEach(function(e){d3.selectAll(".song-"+e.id).style("fill",e.color)},this)}else viewModel.albums().forEach(function(e){d3.selectAll(".album-"+e.id).style("fill",e.color)},this)}),viewModel.selected.subscribe(function(e){if(e){var t=viewModel.albums().find(function(t){return t.id===e});if(!t)return;d3.selectAll(".album-"+t.id).style("fill","#eee")}else d3.selectAll(".from-album").style("fill","#eee")},null,"beforeChange")}function setAffixElementWidth(){var e=$affixElement.parent(),t=e.width()-parseInt($affixElement.css("paddingLeft"))-parseInt($affixElement.css("paddingRight"))-parseInt($affixElement.css("marginLeft"))-parseInt($affixElement.css("marginRight"))-parseInt($affixElement.css("borderLeftWidth"))-parseInt($affixElement.css("borderRightWidth"));$affixElement.width(t)}var opts={lines:10,length:25,width:10,radius:25,scale:.25,corners:1,color:"#000",opacity:.25,rotate:0,direction:1,speed:1,trail:60,fps:20,zIndex:2e9,className:"spinner",top:"50%",left:"50%",shadow:!1,hwaccel:!1,position:"relative"},$spinner=$("#spinner"),spinner=new Spinner(opts).spin($spinner.get(0)),margin={top:0,right:0,bottom:0,left:0},width=500,height=12243,heightSong=10,widthSong=10,viewModel={albums:ko.observableArray([]),slicedAlbums:ko.observableArray([]),options:ko.observableArray([]),selected:ko.observable()};ko.applyBindings(viewModel),$.getJSON("/json/wilco-shows/albums.json",function(e){viewModel.options.push({id:0,name:"All",disabled:!1}),viewModel.options.push({disabled:!0});var t=[],n=[],s=[],r=[];e.albums.forEach(function(e,a){e.formattedReleased=moment(e.released).format("MMMM D, YYYY"),viewModel.options.push({id:e.id,name:e.name,disabled:!1}),viewModel.albums.push(e);var i={name:e.name,abbrev:e.abbrev,color:e.color};a<3?t.push(i):a<6?n.push(i):a<9?s.push(i):r.push(i)}),viewModel.slicedAlbums.push(t),viewModel.slicedAlbums.push(n),viewModel.slicedAlbums.push(s),viewModel.slicedAlbums.push(r),d3.json("/json/wilco-shows/shows.json",function(e,t){var n=t.data;spinner.stop(),$spinner.hide(),$(".graph-section").removeClass("hide"),draw(n),subscribe(),viewModel.selected(0),setAffixElementWidth()})}).fail(function(e){console.error(e)});var $affixElement=$("#affix-element");$(window).resize(function(){setAffixElementWidth()});